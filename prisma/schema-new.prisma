// NEW FLEXIBLE SCHEMA DESIGN
// This will replace the current schema.prisma after migration

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

// Core entities (mostly unchanged)
model Instructor {
  id        String @id @default(cuid())
  name      String
  hourlyWage Int   // in ISK
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  programAssignments ProgramInstructor[]
  
  @@map("instructors")
}

model Year {
  id        String @id @default(cuid())
  year      Int    @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  programs Program[]
  seasons  Season[]
  
  @@map("years")
}

// CHANGED: Now serves as templates only
model ProgramType {
  id          String @id @default(cuid())
  name        String @unique // "Adult Training", "Kids Training", etc.
  description String? // Optional description for templates
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations - now used as templates
  programs Program[]
  templates ProgramTemplate[]
  
  @@map("program_types")
}

// NEW: Flexible program templates system
model ProgramTemplate {
  id          String @id @default(cuid())
  name        String // "U16 Standard Setup", "Adult Full Program", etc.
  description String?
  
  // Template configuration
  programName       String  // Default program name when using template
  sessionDuration   Float   // Hours per session
  isMonthly        Boolean @default(false)
  venueSplitPercent Float   @default(50.0)
  
  // Optional reference to program type for categorization
  programTypeId String?
  programType   ProgramType? @relation(fields: [programTypeId], references: [id])
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  pricingTemplates PricingTemplate[]
  
  @@map("program_templates")
}

// NEW: Template pricing options
model PricingTemplate {
  id          String @id @default(cuid())
  templateId  String
  name        String // "Full Season", "Half Season", "Student Rate", etc.
  price       Int    // Default price in ISK
  order       Int    @default(0) // Display order
  
  // Relations
  template ProgramTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)
  
  @@map("pricing_templates")
}

// CHANGED: Much more flexible program model
model Program {
  id              String @id @default(cuid())
  yearId          String
  programTypeId   String? // Optional - for categorization/templates
  
  // NEW FLEXIBLE FIELDS
  name            String  // Custom program name (e.g., "U16 Advanced Spring")
  sessionDuration Float   // Hours per session (per program)
  isMonthly       Boolean @default(false) // Per program setting
  venueSplitPercent Float @default(50.0) // Per program setting
  
  // REMOVED: fullPrice, halfPrice, subscriptionPrice (now dynamic)
  
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  
  // Relations
  year         Year @relation(fields: [yearId], references: [id])
  programType  ProgramType? @relation(fields: [programTypeId], references: [id])
  seasons      Season[]
  instructors  ProgramInstructor[]
  registrations Registration[]
  
  // NEW: Dynamic pricing options
  pricingOptions PricingOption[]
  
  @@map("programs")
}

// NEW: Dynamic pricing options per program
model PricingOption {
  id        String @id @default(cuid())
  programId String
  name      String // "Full Season", "Student Rate", "Early Bird", etc.
  price     Int    // Price in ISK
  order     Int    @default(0) // Display order
  isActive  Boolean @default(true) // Can disable options without deleting
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  program Program @relation(fields: [programId], references: [id], onDelete: Cascade)
  registrationEntries RegistrationEntry[]
  
  @@map("pricing_options")
}

// Seasons (mostly unchanged)
model Season {
  id        String @id @default(cuid())
  name      String // "Spring 2025", "Summer 2025", "Fall 2025"
  startDate DateTime
  endDate   DateTime
  yearId    String
  programId String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  year     Year @relation(fields: [yearId], references: [id])
  program  Program? @relation(fields: [programId], references: [id])
  registrations Registration[]
  sessions ProgramSession[]
  
  @@map("seasons")
}

// Program Instructors (unchanged)
model ProgramInstructor {
  id           String @id @default(cuid())
  programId    String
  instructorId String
  seasonId     String?
  workDays     Json   // array of days like ["MONDAY", "WEDNESDAY", "FRIDAY"]
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  // Relations
  program    Program @relation(fields: [programId], references: [id])
  instructor Instructor @relation(fields: [instructorId], references: [id])
  
  @@unique([programId, instructorId, seasonId])
  @@map("program_instructors")
}

// CHANGED: Simplified registration model
model Registration {
  id        String @id @default(cuid())
  programId String
  seasonId  String?
  month     Int?    // for monthly programs (1-12)
  
  // REMOVED: fullRegistrations, halfRegistrations, subscriptionRegistrations
  // Now handled by RegistrationEntry
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  program Program @relation(fields: [programId], references: [id])
  season  Season? @relation(fields: [seasonId], references: [id])
  
  // NEW: Dynamic registration entries
  entries RegistrationEntry[]
  
  // Ensure one registration per program/season or program/month
  @@unique([programId, seasonId])
  @@unique([programId, month])
  @@map("registrations")
}

// NEW: Dynamic registration entries
model RegistrationEntry {
  id              String @id @default(cuid())
  registrationId  String
  pricingOptionId String
  quantity        Int    @default(0) // Number of registrations for this pricing option
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  // Relations
  registration   Registration @relation(fields: [registrationId], references: [id], onDelete: Cascade)
  pricingOption  PricingOption @relation(fields: [pricingOptionId], references: [id])
  
  // Ensure one entry per registration/pricing option combination
  @@unique([registrationId, pricingOptionId])
  @@map("registration_entries")
}

// Program Sessions (unchanged)
model ProgramSession {
  id           String @id @default(cuid())
  seasonId     String
  instructorId String
  date         DateTime
  hours        Float
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  
  // Relations
  season Season @relation(fields: [seasonId], references: [id])
  
  @@map("program_sessions")
}